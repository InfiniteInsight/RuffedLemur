<!-- frontend/RuffedLemur/src/app/dashboard/components/expiring-certs-widget/expiring-certs-widget.component.html -->

<div class="expiring-certs-container">
  <h2>Certificates Expiring in {{ daysToShow }} Days</h2>

  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <div *ngIf="error" class="error-message">
    {{ error }}
  </div>

  <mat-card *ngIf="!loading && !error" class="table-card">
    <mat-card-content>
      <div *ngIf="certificates.length === 0" class="no-data-message">
        No certificates expiring in the next {{ daysToShow }} days.
      </div>

      <table mat-table [dataSource]="certificates" *ngIf="certificates.length > 0" class="expiring-table">
        <!-- Certificate Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Certificate</th>
          <td mat-cell *matCellDef="let cert">
            {{ cert.name }}
            <div class="cert-subtitle" *ngIf="cert.owner">
              Owner: {{ cert.owner }}
            </div>
          </td>
        </ng-container>

        <!-- Common Name Column -->
        <ng-container matColumnDef="commonName">
          <th mat-header-cell *matHeaderCellDef>Domain</th>
          <td mat-cell *matCellDef="let cert">
            {{ cert.commonName }}
            <div class="cert-subtitle" *ngIf="cert.authorityName">
              Issued by: {{ cert.authorityName }}
            </div>
          </td>
        </ng-container>

        <!-- Expiration Date Column -->
        <ng-container matColumnDef="expirationDate">
          <th mat-header-cell *matHeaderCellDef>Expires On</th>
          <td mat-cell *matCellDef="let cert">
            {{ cert.expirationDate | date:'mediumDate' }}
          </td>
        </ng-container>

        <!-- Days Until Expiration Column -->
        <ng-container matColumnDef="daysUntilExpiration">
          <th mat-header-cell *matHeaderCellDef>Days Left</th>
          <td mat-cell *matCellDef="let cert" [ngClass]="getSeverityClass(cert.daysUntilExpiration || 0)">
            {{ cert.daysUntilExpiration }}
            <mat-icon *ngIf="cert.daysUntilExpiration <= 3" matTooltip="Critical: Expires in 3 days or less">
              priority_high
            </mat-icon>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let cert">
            <button mat-icon-button color="primary" [routerLink]="['/certificates', cert.id]"
                    matTooltip="View Certificate">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button color="accent" [routerLink]="['/certificates', cert.id, 'renew']"
                    matTooltip="Renew Certificate">
              <mat-icon>autorenew</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <div class="view-all-link" *ngIf="certificates.length > 0">
        <a [routerLink]="['/certificates']" [queryParams]="{expiring: 'true'}">View all expiring certificates</a>
      </div>
    </mat-card-content>
  </mat-card>
</div>
